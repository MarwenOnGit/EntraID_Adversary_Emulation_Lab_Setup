---
- name: Install base packages (git, go)
  hosts: redteam
  become: yes
  vars:
    go_version: "1.21.2"
    go_tar: "go{{ go_version }}.linux-amd64.tar.gz"
    go_url: "https://go.dev/dl/{{ go_tar }}"
    go_install_dir: /usr/local
  tasks:
    - name: Ensure python3 is present for Ansible
      raw: test -e /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    - name: Gather facts
      setup:

    - name: Install git (Debian/Ubuntu)
      apt:
        name: git
        state: present
      when: ansible_facts['pkg_mgr'] == 'apt'

    - name: Install git (RHEL/CentOS/Amazon)
      yum:
        name: git
        state: present
      when: ansible_facts['pkg_mgr'] in ['yum','dnf']

    - name: Check existing go version
      command: go version
      register: go_version_check
      ignore_errors: yes

    - name: Install Go by downloading tarball
      when: go_version_check.rc != 0
      block:
        - name: Download Go tarball
          get_url:
            url: "{{ go_url }}"
            dest: "/tmp/{{ go_tar }}"
            mode: '0644'

        - name: Remove any existing /usr/local/go
          file:
            path: "{{ go_install_dir }}/go"
            state: absent
            recurse: yes

        - name: Extract Go to /usr/local
          unarchive:
            src: "/tmp/{{ go_tar }}"
            dest: "{{ go_install_dir }}"
            remote_src: yes

        - name: Ensure /etc/profile.d/go.sh exists
          copy:
            dest: /etc/profile.d/go.sh
            content: |
              export GOROOT=/usr/local/go
              export GOPATH=$HOME/go
              export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
            mode: '0755'

    - name: Ensure go binary is present in PATH
      command: /usr/local/go/bin/go version
      register: go_check
      ignore_errors: yes

    - name: Show installed versions
      debug:
        msg: "Git and Go installation completed. {{ go_check.stdout }}"
